# DeltaFStation 更新记录 / Changelog

## v0.7.4 （2026-02-09）

**定位**：交易功能闭环实现与 UI/UX 深度打磨。

- **后端功能集成 (deltafq)**
  - **交易全链路对接**：全面集成 `deltafq` 的 `OrderManager` 和 `PositionManager`，实现买入、卖出、撤单功能的后端闭环。
  - **动态行情订阅**：下单时自动触发 `deltafq` 的行情订阅逻辑，确保交易标的实时匹配。
  - **数据精准映射**：完善委托记录（Orders）、成交历史（Trades）和实时持仓（Positions）的后端拉取与前端展示。
- **UI/UX 视觉优化**
  - **数据视图切换**：重构「委托/成交/持仓」切换按钮，样式与顶部「分时/日K」分段控件完全对齐；移除卡片头部冗余文本标题，实现极简布局。
  - **模态框升级**：引入自定义 Bootstrap 模态框处理账户关闭确认，替换原生 `confirm` 弹窗。
  - **表单交互**：买入/卖出委托数量默认值 100；按钮色彩语义化（红买绿卖）。
- **交互逻辑与稳定性**
  - **自动价格重置**：标的切换后自动重置委托价格，防止残留旧标的数据。
  - **文件名规范化**：账户存储统一命名为 `sim_YYYYMMDD001.json`。
  - **预校验机制**：增加前端资金与持仓预校验，修复账户关闭后的数据残留问题。

---

## v0.7.3 （2026-02-08）

**定位**：账户管理重构，全面接入 deltafq 本地模拟，界面统一为「管理账户」入口。

- **仿真引擎**：SimulationEngine 重写为基于 deltafq（EventEngine + yfinance + paper），按 tick 撮合；账户配置由 API 层写入 `data/simulations/`。
- **账户规则**：支持自定义账户名称、仅允许一个账户运行；选择已有账户时若已关闭则自动 `/start` 开启。
- **交易页**：「创建账户」改为「管理账户」弹层，内嵌已有账户列表与新建表单，选/建成功后关闭弹层；左侧卡片仅展示当前账户信息与关闭按钮。
- **API**：新增 `POST /api/simulations/<id>/start`，列表/状态返回 `name`，创建必填 `name`；券商实盘仅前端占位。

---

## v0.7.2 （2026-02-02）

**定位**：实时行情稳定性增强与前端渲染性能优化。

- **实时行情系统 (LiveDataManager) 优化**
  - **并发安全**：重构订阅逻辑，解决多线程环境下可能导致的竞态冲突。
  - **性能缓存**：引入 OHLC 数据 60s 缓存机制，显著降低对外部 API 的请求频率。
  - **健壮性**：增加网关初始化保护与详细的错误日志追踪。
- **前端交易界面 (Trader.js) 性能提升**
  - **响应提速**：将行情轮询间隔从 5s 缩短至 2s，显著提升 UI 动态反馈感。
  - **图表修复**：修复分时图在初次加载及跨市场品种切换时的时区轴对齐问题。
  - **Hash 联动**：优化 URL Hash 监听逻辑，确保标的切换时图表轴同步重构。

---

## v0.7.1 （2026-01-29）

**定位**：全球交易视野增强与交互体验深度优化。

- **全球视野升级**
  - **多时区时钟组**：右上角新增“北京/美东/UTC”三地实时时钟，支持独立秒级跳动，解耦数据更新频率。
  - **深度链接支持**：引入 URL Hash 机制（Deep Linking），支持直接通过 URL（如 `#AAPL`）切换标的，并支持浏览器前进/后退及刷新状态持久化。
- **交互与视觉精进**
  - **标的选择器重构**：将投资标的由 Select 恢复为 Input + Datalist，兼顾自由输入与极简提示，支持全能标的快速切换。
  - **分时图健壮性**：新增盘后数据溢出兼容逻辑，防止非交易时段图表空白；优化成交量轴标签显示，消除与价格轴标签的重叠干扰。
- **时区模型微调**
  - **加密货币回归 UTC**：后端统一将加密货币（BTC/ETH等）归一化为 UTC 拨分数据，确保分时轴全球对齐。

---

## v0.7.0 （2026-01-29）

**定位**：实时行情系统实现与UTC时区标准化

- **实时行情系统实现**
  - **后端核心实现 (`live_data_manager.py`)**：新增 `LiveDataManager` 类，基于 `deltafq` 实现多市场实时行情订阅、去重及历史 Tick 维护。
  - **API 接口封装 (`data_api.py`)**：新增 `/api/data/quotes/<symbol>` 接口，支持实时行情获取与历史数据补全（history 参数）。
  - **服务生命周期管理 (`app.py`)**：在应用启动时自动初始化并运行 `LiveDataManager` 服务。
  - **前端数据联动 (`trader.js`)**：实现行情自动更新循环（updateAll），支持图表、价格及盘口数据的实时渲染。
- **交易界面交互优化**
  - **快速输入支持**：投资标的输入框支持回车（Enter）直接触发更新，无需点击外部。
  - **标的名称映射优化**：标的名称默认同步显示标的代码，为后续多语言字典映射预留空间。
- **时间系统标准化**
  - **后端去时区化**：`LiveDataManager` 统一采用 Naive UTC 时间处理，解决部分环境下时区偏移导致的绘图失败。
  - **前端 UTC 适配**：重构分时图时间轴（A股/美股/加密货币）及行情时间显示逻辑，完美匹配 UTC 拨分数据。

---

## v0.6.6 （2026-01-18）

**定位**：代码架构优化与职责分离，提升可维护性。

- **回测 API 层优化 (backtest_api.py)**
  - **代码精简**：从 324 行减少到 194 行（减少 40%），移除冗余逻辑。
  - **路径常量提取**：统一提取 `_DATA_RESULTS_FOLDER` 等路径常量，消除重复构建。
  - **函数简化**：优化 `_convert_to_json_serializable` 函数，移除冗余的 NaN/Infinity 检查逻辑。
  - **职责清晰**：API 层专注于 HTTP 请求/响应处理和结果序列化。

- **回测引擎优化 (backtest_engine.py)**
  - **代码精简**：从 210 行减少到 241 行（新增功能但逻辑更清晰）。
  - **移除冗余返回值**：`run_backtest` 方法移除未使用的返回值字典，改为返回 `None`。
  - **路径常量提取**：统一提取 `_STRATEGIES_FOLDER` 和 `_DATA_RAW_FOLDER` 路径常量。
  - **条件判断优化**：简化策略类查找逻辑，提升代码可读性。

- **架构重构：职责分离**
  - **数据处理逻辑迁移**：将数据加载、日期过滤、symbol 提取等业务逻辑从 API 层迁移到 Core 层。
  - **新增 Core 层方法**：
    - `load_and_prepare_data()`: 统一处理数据加载和预处理，包含完整的数据验证。
    - `run_backtest_from_file()`: 高级接口，接受文件路径等参数，封装完整的回测流程。
  - **符合 RESTful 规范**：API 层仅负责 HTTP 适配，Core 层负责业务逻辑，提升代码可测试性和可复用性。
  - **向后兼容**：保留原有的 `run_backtest` 方法（接受 DataFrame），确保兼容性。

- **代码质量提升**
  - 统一异常处理，Core 层抛出明确的业务异常（`FileNotFoundError`、`ValueError`）。
  - 移除不必要的导入和常量，代码结构更清晰。
  - 提升代码可维护性和可扩展性。

---

## v0.6.5 （2026-01-16）

**定位**：交易页面 UI/UX 优化与功能完善。

- **交易页面布局优化**：左栏委托数量和价格输入框加粗显示，买1/现价/卖1按钮统一展开；委托-成交-持仓卡片添加滚动条支持；交易账户卡片内部布局优化，标签与数值对齐统一。
- **账户管理功能完善**：完善创建/关闭账户逻辑，支持模拟模式，即使后端不可用也能完整展示功能；账户信息显示优化，动态生成账户ID，费率信息正确展示。
- **实时行情优化**：优化买卖盘口字号和间距，提升可读性；优化价格和涨跌幅的显示位置和样式。

---

## v0.6.4 （2026-01-16）

**定位**：回测可视化重构与多维数据对齐。

- **多表关联可视化**
  - **布局重构**：新增独立“价格走势”图表，账户净值图回归纯粹，显著降低视觉干扰。
  - **动态图例**：图例从画布移至卡片标题栏，极大节省空间并实时显示最新净值/价格数值。
  - **视觉优化**：统一使用低饱和度实线绘制基准与标的曲线，视觉风格更加专业、聚焦。

- **基准对标与数据对齐**
  - **实时基准**：支持上证指数（000001.SS）作为回测基准，实时获取真实市场参考线。
  - **智能对齐**：重构数据同步逻辑，自动处理非交易日缺失值填充，确保多条曲线精准对齐。
  - **API 增强**：`data_api.py` 支持 `full` 参数，为前端提供高精度全量历史数据。

- **代码冗余清理**
  - **架构一致性**：全项目 JavaScript 统一使用公共 `apiRequest` 封装，移除各页面冗余 fetch 代码。
  - **逻辑精简**：移除前端对数据列名的复杂兼容性校验，基于后端统一首字母大写的规范（Date, Close）。
  - **工具统一**：重构 `common.js` 工具函数，统一全站日期时间显示格式（formatDateTime/formatTime）。

---

## v0.6.3 （2026-01-15）

**定位**：代码深度优化与前端性能提升。

- **前端架构优化 (backtest.js)**
  - **消除冗余**：提取 `getChartTooltipCallbacks` 统一处理图表日期与数值格式化逻辑。
  - **性能提升**：重构 `parseValuesDf` 预判键名，消除大规模数据处理时的嵌套循环开销。
  - **配置驱动**：解耦 20+ 绩效指标显示逻辑，重构为配置驱动模式，增强代码维护性。
  - **模块化**：拆分 `runBacktest` 主逻辑为参数收集、数据同步、回测执行等独立单元。

- **可视化深度改进**
  - **PnL 分布图**：增加至 50 分箱并过滤 0 收益样本，更真实反映策略盈亏特性。
  - **坐标轴增强**：精准实现 0 轴红色虚线高亮，移除多余标签，保持专业视觉风格。

- **Bug 修复与清理**
  - **修复**：修正图表插件语法错误及 `chart.min.css` 冗余引用导致的控制台 404。

---

## v0.6.2 （2026-01-14）

**定位**：策略管理闭环与 API 设计规范化。

- **策略管理功能闭环**
  - **全方位管理**：统一回测与运行页面的策略管理交互，支持源码查看、脚本上传、文件下载及物理删除。
  - **逻辑重构**：后端 `strategy_api.py` 彻底重构为 RESTful 风格，通过 `action` 参数区分源码读取与文件下载，保持 API 设计的一致性。
  - **安全增强**：策略上传引入 `secure_filename` 过滤，防止路径穿透风险。
  - **移除冗余**：清理了未实现的“在线编辑”占位功能及相关图标，保持界面专注、专业。

- **UI/UX 深度打磨**
  - **交互精简**：优化删除策略、清空历史等关键操作的提示语；统一使用“垃圾桶”图标表示清空操作，移除冗余文字描述。
  - **布局优化**：重构 `gostrategy` 页面策略配置区域，实现标签、操作按钮、下拉框的错落有序排列，提升表单可读性。
  - **细节改进**：数据管理下载模板图标更换为 `fa-file-csv`，避免与数据下载混淆；策略下拉框增加 `(data/strategies)` 路径提示，指引用户存放位置。

- **代码维护性提升**
  - **DRY 原则**：统一策略文件查找逻辑，引入内部辅助函数 `_get_strategy_filepath`。
  - **前端清理**：移除 `common.js` 中已废弃的编辑函数，简化回测与运行页面的初始化逻辑。

---

## v0.6.1 （2026-01-13）

**定位**：代码架构优化，提升可维护性。

- **数据管理模块重构**
  - **业务逻辑分离**：将数据获取逻辑从 API 层迁移到 Core 层（`DataManager`），遵循分层架构原则。
  - **代码简化**：`data_api.py` 从 367 行减少到 230 行（减少 37%），职责更清晰。
  - **统一数据获取**：新增 `fetch_data()` 方法，统一处理数据下载、增量更新、多数据源支持（deltafq/yfinance）。
  - **代码清理**：移除未使用的功能（`load_data`、`process_data`、技术指标计算等），`data_manager.py` 从 288 行减少到 168 行（减少 42%）。

- **架构改进**
  - API 层专注于 HTTP 请求/响应处理，业务逻辑集中在 Core 层。
  - 提升代码可测试性和可维护性。
  - 移除不必要的依赖（numpy），简化项目结构。

---

## v0.6.0 （2026-01-13）

**定位**：可视化性能飞跃，交互体验全方位增强。

- **数据可视化深度优化 (Chart.js)**
  - **智能数据聚合**：根据回测跨度自动切换日/周/月计点，长跨度回测不再“糊”，性能提升 90%+。
  - **视觉降噪**：隐藏数据点标记 (`pointRadius: 0`)，仅在悬停时显示，曲线更顺滑、专业。
  - **极简轴标签**：X 轴日期格式改为 `YY/M` (如 `25/1`)，彻底解决标签重叠问题。

- **实时系统监控 (Live Console)**
  - **实时日志流**：集成 SSE (Server-Sent Events) 技术，将 Terminal 输出毫秒级推送到前端控制台。
  - **原生风格控制台**：新增 Live Console 面板，支持颜色标识级别（INFO/WARN/ERROR）及一键清空。

- **数据管理体验升级**
  - **标准化命名**：上传和同步数据统一以 `SYMBOL.csv` 命名，不再添加冗余日期前缀。
  - **一键快速引用**：数据列表中增加“播放”按钮，点击即刻自动填充回测参数并平滑跳转。
  - **增强预览**：数据预览支持“头尾双检”（前50+后50条），显示总行数与日期跨度，并实现表头冻结。
  - **模板支持**：提供标准 CSV 数据模板下载，降低用户上手门槛。

- **回测功能完善**
  - **智能同步逻辑**：运行回测时优先更新本地数据至最新，若无本地则下载全量历史数据。
  - **结果管理优化**：回测历史命名更具辨识度（策略_标的_日期范围），增加“一键清空历史”功能。
  - **默认参数调整**：回测默认起始日期优化为“2年前”，更符合实际调研习惯。

- **UI/UX 细节打磨**
  - **日历组件升级**：引入 Flatpickr，支持年份下拉快速跳转，长跨度日期选择更高效。
  - **精准对齐**：重构回测页面卡片布局，统一卡片高度与边距，解决第一栏底部过长导致的错位。
  - **Bug 修复**：修复回测结果标的显示为 `_ASSET` 的问题；修正历史记录创建时间截断的显示错误。

---

## v0.5.0 （2025-01-11）

**定位**：API 架构优化，全面改造为 RESTful 风格。

- **API 架构重构**
  - 将所有 API 端点从动作导向改为资源导向，符合 RESTful 设计规范
  - 资源路径统一使用复数形式：`/api/strategies`、`/api/backtests`、`/api/simulations`
  - 移除 URL 中的动作动词（`create`、`upload`、`list`、`run` 等），使用 HTTP 方法表示操作

- **API 端点变更**
  - **策略 API**：`POST /api/strategy/create` → `POST /api/strategies`，`GET /api/strategy/list` → `GET /api/strategies`
  - **回测 API**：`POST /api/backtest/run` → `POST /api/backtests`，`GET /api/backtest/results` → `GET /api/backtests`
  - **仿真 API**：`POST /api/simulation/start` → `POST /api/simulations`，`POST /api/simulation/stop/<id>` → `PUT /api/simulations/<id>`
  - **数据 API**：`POST /api/data/upload` → `POST /api/data/files`，`GET /api/data/list` → `GET /api/data/files`
  - **交易 API**：`POST /api/simulation/trade/<id>` → `POST /api/simulations/<id>/trades`

- **前端适配**
  - 更新所有前端 JavaScript 文件（`backtest.js`、`gostrategy.js`、`trader.js`）以适配新的 RESTful API
  - 优化 API 调用逻辑，确保与后端接口完全兼容

- **代码质量提升**
  - 统一 API 设计规范，提升代码可维护性和可扩展性
  - 改进 API 的可发现性和语义化，便于开发者理解和使用

---

## v0.4.0 （2025-12-05）

**定位**：AI 小助手功能上线，提升用户体验。

- 新增右下角浮标式 AI 小助手，支持智能问答、上下文感知和 Markdown 消息格式。
- 优化聊天窗口尺寸（450×500px）、浮标按钮（50×50px）。
- 聊天消息及窗口应用毛玻璃视觉效果，适配桌面和移动端。
- 统一字体和透明度设定，整体提升 UI/UX 体验。

---

## v0.3.0 （2025-12-04）

**定位**：交易功能完善 + 代码优化。

- 实现手动交易界面（`trader.html`）：账户创建、手动买卖、持仓管理、交易记录跟踪。
- 实现策略运行界面（`gostrategy.html`）：策略启动、实时监控、资产曲线、交易日志。
- 增加模拟数据支持：仿真交易使用演示数据，支持策略自动交易和手动交易。
- 代码优化：抽离公共模块（`common.css`、`common.js`），精简重复代码，完善文档和 Git 规范。

---

## v0.2.0 （2025-12-03）

**定位**：回测功能完整实现，集成 deltafq 量化框架。

- **回测界面实现**
  - 完成 `backtest.html` 策略回测页面：策略选择、数据文件管理、回测参数配置、历史记录查看。
  - 实现 `backtest.js` 前端逻辑：策略加载、数据预览、回测执行、结果可视化（资产曲线、回撤图、收益分布等）。
  - 集成 Chart.js 实现多维度回测结果图表展示。

- **后端回测引擎集成**
  - 实现 `backend/core/backtest_engine.py`：封装 deltafq 的 `BacktestEngine`，提供统一的回测接口。
  - 实现 `backend/api/backtest_api.py`：提供回测执行、结果查询、历史记录管理等 RESTful API。
  - 支持从 `data/strategies/` 目录动态加载 Python 策略类，策略类需继承 deltafq 的 `BaseStrategy`。

- **策略管理**
  - 实现策略文件自动发现机制：扫描 `data/strategies/` 目录下的 `.py` 文件，识别策略类。
  - 提供策略列表查询 API，支持策略元数据（名称、描述等）获取。

- **数据管理增强**
  - 支持 CSV 数据文件上传和 Yahoo Finance 数据下载。
  - 实现数据预览功能，支持前端查看数据文件内容。

---

## v0.1.0 （初始版本）

- 基于 Flask + Bootstrap 5 + Chart.js 搭建的单机量化交易 Web 系统。
- 后端包含：数据管理、策略管理、回测引擎、仿真引擎四大块，全部使用文件（CSV / JSON）作为存储。
- 前端提供：
  - `index`：入口主页；
  - `strategy`：策略创建与回测入口（对应 backtest 页面）；
  - `trading`：手动仿真交易界面（对应 trader 页面）；
  - `run`：策略自动运行与实时监控界面（对应 gostrategy 页面）。
- 回测与策略体系基于 `deltafq` 框架封装，支持自定义 Python 策略类。
